<!DOCTYPE html>
<html lang="ko"
      layout:decorate="~{_layout.html}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org"
>
<head>
	<style layout:fragment="style"></style>
	<title th:text="|프로필 편집|"></title>
</head>
<div class="container my-5" layout:fragment="content">
	
	<div class="card mx-auto" style="max-width: 500px">
		<div class="card-body">
			<h5 class="card-title" th:text="|${userDTO.nickname}님의 프로필 설정입니다|"></h5>
			
			<form id="user-update-form">
				<div class="my-4" th:action="@{/user/upddate/image}">
					<div class="text-center"
					     th:with="fallbackUrl = 'https://avatar.iran.liara.run/username?username=' + ${userDTO.nickname}">
						<img height="65"
						     id="image"
						     th:src="${userDTO.image?.url == null
						     ? fallbackUrl : userDTO.image.url}"
						     width="65">
					</div>
					<label>프로필 사진</label>
					<input class="form-control" id="user-file-input" name="file" type="file">
					<div class="form-text">프로필 사진은 1MB 이하여야 하며, image/jpeg와 image/png 이미지만 사용 가능합니다.</div>
				</div>
				
				<div>
					<div class="my-2">
						<label for="username">아이디</label>
						<input class="form-control" id="username" readonly th:value="${userDTO.username}" type="text"/>
					</div>
					
					<div class="my-2">
						<label for="nickname">닉네임</label>
						<input class="form-control" id="nickname" name="nickname"
						       th:placeholder="${userDTO.nickname}"
						       type="text"/>
						<div class="form-text">다른 사용자들에게 보여지는 이름입니다. 2-10자의 영문 대소문자, 한글, 숫자를 사용 가능합니다.</div>
					</div>
					
					<div class="my-2">
						<label for="old-password">현재 비밀번호</label>
						<input class="form-control" id="old-password" name="oldPassword" type="password"/>
						<div class="form-text">비밀번호를 변경하려면 현재 비밀번호를 입력하세요.</div>
					</div>
					
					<div class="my-2">
						<label for="new-password">변경할 비밀번호</label>
						<input class="form-control" id="new-password" name="newPassword" type="password"/>
						<div class="form-text">비밀번호는 8자부터 12자의 한글, 영문 대소문자, 숫자, 특수문자를 사용할 수 있습니다.</div>
					</div>
					
					<div class="mt-4">
						<button class="btn btn-primary w-100" type="submit">저장</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<th:block layout:fragment="script">
	<script>
		
		let isNewImage = false
		let oldImageUrl = ''
		const image = document.getElementById('image')
		
		function setOldImageUrl() {
			
			if (oldImageUrl !== '') {
				
				image.src = oldImageUrl
			}
		}
		
		/**
		 * @param e {InputEvent}
		 */
		function onFileInput(e) {
			
			isNewImage = false
			
			const fileInput = e.target
			const file = fileInput.files[0]
			
			if (!file) return
			
			const allowedTypes = ['image/jpeg', 'image/png']
			
			if (!allowedTypes.includes(file.type)) {
				
				alert('JPEG 또는 PNG 이미지 파일만 업로드 가능합니다.')
				fileInput.value = ''
				setOldImageUrl()
				
				return
			}
			
			const maxSize = 1024 * 1024
			if (file.size > maxSize) {
				
				alert('파일 크기는 1MB를 초과할 수 없습니다.')
				fileInput.value = ''
				setOldImageUrl()
				
				return
			}
			
			isNewImage = true
			
			if (!oldImageUrl) {
				oldImageUrl = image.src
			}
			
			if (image.src.startsWith('blob:')) {
				URL.revokeObjectURL(image.src)
			}
			image.src = URL.createObjectURL(file)
		}
		
		document.querySelector('#user-file-input').addEventListener('change', onFileInput)
		
		/**
		 * @param e {SubmitEvent}
		 */
		async function onUserUpdate(e) {
			
			e.preventDefault()
			if (window.isSubmitting) return
			window.isSubmitting = true
			
			const form = e.target
			let isValid = true
			
			const submitButton = form.querySelector('button[type="submit"]')
			submitButton.disabled = true
			submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 처리 중...'
			
			if (isNewImage) {
				
				try {
					
					const formData = new FormData()
					formData.append('file', form.file.files[0])
					
					const response = await fetch('/user/update/image', {
						method: 'post',
						headers: window.customHeaders,
						body: formData,
					})
					
					if (!response.ok) throw new Error()
					
					alert('이미지를 저장했습니다.')
				} catch (err) {
					
					alert('이미지를 저장하지 못했습니다.')
				} finally {
					
					isNewImage = false
				}
			}
			
			// nickname
			const nickname = form.nickname
			const nicknameVal = nickname.value
			const nicknameRegex = window.nicknameRegex
			let isNicknameTouched = false
			
			if (nicknameVal.length !== 0) {
				if (!nicknameRegex.test(nicknameVal)) {
					
					isValid = false
					alert('유효한 닉네임이 아닙니다.')
					
				} else {
					
					isNicknameTouched = true
				}
			}
			
			// password
			const oldPassword = form.oldPassword
			let oldPasswordVal = oldPassword.value
			const newPassword = form.newPassword
			const newPasswordVal = newPassword.value
			const passwordRegex = window.passwordRegex
			let isPasswordTouched = false
			
			if (newPasswordVal.length !== 0) {
				
				if (oldPasswordVal.length === 0) {
					
					isValid = false
					alert('비밀번호를 변경하려면 현재 비밀번호를 입력해야 합니다.')
				} else if (!passwordRegex.test(newPasswordVal)
						|| !passwordRegex.test(oldPasswordVal)) {
					
					isValid = false
					alert('유효한 비밀번호가 아닙니다.')
				} else {
					
					isPasswordTouched = true
				}
			}
			
			try {
				
				if (!isNicknameTouched && !isPasswordTouched) throw new Error()
				
				if (!isValid) throw new Error()
				
				const body = {}
				if (isNicknameTouched) {
					body.nickname = nicknameVal
				}
				if (isPasswordTouched) {
					body.oldPassword = oldPasswordVal
					body.newPassword = newPasswordVal
				}
				
				const response = await fetch('/user/update', {
					method: 'post',
					headers: window.customJsonHeaders,
					body: JSON.stringify(body),
				})
				
				if (!response.ok) {
					
					const data = await response.json()
					
					alert(data.message)
					
					throw new Error()
				}
				
				window.location.reload()
			} catch (err) {
				
				submitButton.disabled = false
				submitButton.innerHTML = '저장'
				window.isSubmitting = false
			}
		}
		
		document.querySelector('#user-update-form').addEventListener('submit', onUserUpdate)
		document.querySelector('#user-update-form').addEventListener('keydown', window.preventEnterSubmit)
	</script>
</th:block>
</html>
